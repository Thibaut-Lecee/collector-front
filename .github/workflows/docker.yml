name: Docker

on:
  workflow_call:
    inputs:
      ref:
        required: true
        type: string

defaults:
  run:
    working-directory: ./

permissions:
  contents: read
  packages: write

jobs:
  docker-scan-deploy:
    runs-on: ubuntu-latest
    name: Scan & Deploy

    steps:
      - name: Harden runner
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ref: ${{ inputs.ref }}

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image (local)
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          load: true
          tags: collector-front:ci

      - name: Prepare GHCR tags
        id: ghcr
        shell: bash
        run: |
          set -euo pipefail

          owner='${{ github.repository_owner }}'
          repo="${GITHUB_REPOSITORY#*/}"

          # GHCR/Docker image names must be lowercase
          owner="${owner,,}"
          repo="${repo,,}"
          image="ghcr.io/${owner}/${repo}-front"

          echo "image=${image}" >> "$GITHUB_OUTPUT"
          echo "sha_tag=${image}:${{ github.sha }}" >> "$GITHUB_OUTPUT"

          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "latest_tag=${image}:latest" >> "$GITHUB_OUTPUT"
          else
            echo "latest_tag=" >> "$GITHUB_OUTPUT"
          fi

          if [[ "${{ github.ref }}" == refs/heads/* ]]; then
            echo "should_push=true" >> "$GITHUB_OUTPUT"
          else
            echo "should_push=false" >> "$GITHUB_OUTPUT"
          fi

          echo "GHCR image: ${image}"
          echo "SHA tag: ${image}:${{ github.sha }}"
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "Latest tag: ${image}:latest"
          fi

      # Quality gate: CRITICAL vulnerabilities fail the workflow; HIGH are reported (warning only).
      - name: Trivy scan (collector-front) [CRITICAL - block]
        uses: aquasecurity/trivy-action@0.34.0
        with:
          image-ref: collector-front:ci
          scan-type: image
          format: table
          vuln-type: os,library
          severity: CRITICAL
          ignore-unfixed: true
          exit-code: "1"

      - name: Trivy scan (collector-front) [HIGH - warning]
        if: always() && steps.build.outcome == 'success'
        uses: aquasecurity/trivy-action@0.34.0
        with:
          image-ref: collector-front:ci
          scan-type: image
          format: table
          vuln-type: os,library
          severity: HIGH
          ignore-unfixed: true
          exit-code: "0"

      - name: Login to GHCR
        if: steps.ghcr.outputs.should_push == 'true'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ github.token }}

      - name: Push image to GHCR
        if: steps.ghcr.outputs.should_push == 'true'
        shell: bash
        run: |
          set -euo pipefail
          docker tag collector-front:ci "${{ steps.ghcr.outputs.sha_tag }}"
          docker push "${{ steps.ghcr.outputs.sha_tag }}"

          if [[ -n "${{ steps.ghcr.outputs.latest_tag }}" ]]; then
            docker tag collector-front:ci "${{ steps.ghcr.outputs.latest_tag }}"
            docker push "${{ steps.ghcr.outputs.latest_tag }}"
          fi
