name: Docker

on:
  workflow_call:
    inputs:
      ref:
        required: true
        type: string

defaults:
  run:
    working-directory: ./

permissions:
  contents: read

jobs:
  docker-scan-deploy:
    runs-on: ubuntu-latest
    name: Scan & Deploy

    steps:
      - name: Harden runner
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          ref: ${{ inputs.ref }}

      - name: Build Docker image
        run: docker build -t collector-front:ci .

      # Quality gate: CRITICAL vulnerabilities fail the workflow; HIGH are reported (warning only).
      - name: Trivy scan (collector-front) [CRITICAL - block]
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: collector-front:ci
          scan-type: image
          format: table
          vuln-type: os,library
          severity: CRITICAL
          ignore-unfixed: true
          exit-code: "1"

      - name: Trivy scan (collector-front) [HIGH - warning]
        if: always()
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: collector-front:ci
          scan-type: image
          format: table
          vuln-type: os,library
          severity: HIGH
          ignore-unfixed: true
          exit-code: "0"

      - name: Deploy locally (Docker)
        run: |
          docker run -d --name collector-front-ci -p 3000:3000 \
            -e NODE_ENV=production \
            -e PORT=3000 \
            -e NEXTAUTH_URL=http://localhost:3000 \
            -e SESSION_SECRET=ci-session-secret \
            -e SESSION_DURATION=3600 \
            -e ZITADEL_DOMAIN=https://example.com \
            -e ZITADEL_CLIENT_ID=ci-client-id \
            -e ZITADEL_CLIENT_SECRET=ci-client-secret \
            -e ZITADEL_CALLBACK_URL=http://localhost:3000/api/auth/callback/zitadel \
            -e ZITADEL_POST_LOGOUT_URL=http://localhost:3000/api/auth/logout/callback \
            -e NEXT_PUBLIC_API_URL=http://localhost:3001/api \
            collector-front:ci

          for i in {1..30}; do
            if curl -fsS http://localhost:3000/health >/dev/null; then
              echo "Frontend is up"
              exit 0
            fi
            sleep 2
          done

          echo "Frontend did not start"
          docker logs collector-front-ci
          exit 1

      - name: Stop container
        if: always()
        run: docker rm -f collector-front-ci
