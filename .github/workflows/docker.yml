name: Docker

on:
  workflow_call:
    inputs:
      ref:
        required: true
        type: string

defaults:
  run:
    working-directory: ./

permissions:
  contents: read
  packages: write

jobs:
  docker-scan-deploy:
    runs-on: ubuntu-latest
    name: Scan & Deploy

    steps:
      - name: Harden runner
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          ref: ${{ inputs.ref }}

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image (local)
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          load: true
          tags: collector-front:ci

      - name: Prepare GHCR tags
        id: ghcr
        shell: bash
        run: |
          set -euo pipefail

          owner='${{ github.repository_owner }}'
          repo="${GITHUB_REPOSITORY#*/}"

          # GHCR/Docker image names must be lowercase
          owner="${owner,,}"
          repo="${repo,,}"
          image="ghcr.io/${owner}/${repo}-front"

          echo "image=${image}" >> "$GITHUB_OUTPUT"
          echo "sha_tag=${image}:${{ github.sha }}" >> "$GITHUB_OUTPUT"

          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "latest_tag=${image}:latest" >> "$GITHUB_OUTPUT"
          else
            echo "latest_tag=" >> "$GITHUB_OUTPUT"
          fi

          if [[ "${{ github.ref }}" == refs/heads/* ]]; then
            echo "should_push=true" >> "$GITHUB_OUTPUT"
          else
            echo "should_push=false" >> "$GITHUB_OUTPUT"
          fi

          echo "GHCR image: ${image}"
          echo "SHA tag: ${image}:${{ github.sha }}"
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "Latest tag: ${image}:latest"
          fi

      # Quality gate: CRITICAL vulnerabilities fail the workflow; HIGH are reported (warning only).
      - name: Trivy scan (collector-front) [CRITICAL - block]
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: collector-front:ci
          scan-type: image
          format: table
          vuln-type: os,library
          severity: CRITICAL
          ignore-unfixed: true
          exit-code: "1"

      - name: Trivy scan (collector-front) [HIGH - warning]
        if: always() && steps.build.outcome == 'success'
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: collector-front:ci
          scan-type: image
          format: table
          vuln-type: os,library
          severity: HIGH
          ignore-unfixed: true
          exit-code: "0"

      - name: Deploy locally (Docker)
        run: |
          docker run -d --name collector-front-ci -p 3000:3000 \
            -e NODE_ENV=production \
            -e PORT=3000 \
            -e NEXTAUTH_URL=http://localhost:3000 \
            -e SESSION_SECRET=ci-session-secret \
            -e SESSION_DURATION=3600 \
            -e ZITADEL_DOMAIN=https://example.com \
            -e ZITADEL_CLIENT_ID=ci-client-id \
            -e ZITADEL_CLIENT_SECRET=ci-client-secret \
            -e ZITADEL_CALLBACK_URL=http://localhost:3000/api/auth/callback/zitadel \
            -e ZITADEL_POST_LOGOUT_URL=http://localhost:3000/api/auth/logout/callback \
            -e NEXT_PUBLIC_API_URL=http://localhost:3001/api \
            collector-front:ci

          for i in {1..30}; do
            if curl -fsS http://localhost:3000/health >/dev/null; then
              echo "Frontend is up"
              exit 0
            fi
            sleep 2
          done

          echo "Frontend did not start"
          docker logs collector-front-ci
          exit 1

      - name: Stop container
        if: always()
        run: docker rm -f collector-front-ci

      - name: Login to GHCR
        if: steps.ghcr.outputs.should_push == 'true'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ github.token }}

      - name: Push image to GHCR
        if: steps.ghcr.outputs.should_push == 'true'
        shell: bash
        run: |
          set -euo pipefail
          docker tag collector-front:ci "${{ steps.ghcr.outputs.sha_tag }}"
          docker push "${{ steps.ghcr.outputs.sha_tag }}"

          if [[ -n "${{ steps.ghcr.outputs.latest_tag }}" ]]; then
            docker tag collector-front:ci "${{ steps.ghcr.outputs.latest_tag }}"
            docker push "${{ steps.ghcr.outputs.latest_tag }}"
          fi
